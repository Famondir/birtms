---
title: "Graphical Model Evaluation"
author: "Simon Schäfer"
date: "9 8 2021"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(brms)

glob_refit = FALSE
```

Lade unterschiedliche Datensätze.

```{r}
data_spm <- rio::import("../data/data_spm.rda")

data_eirt <- read_csv("https://raw.githubusercontent.com/danielbkatz/EIRT/master/eirtdata.csv")
data_eirt <- data_eirt[-1]
data_eirt <- data_eirt %>% mutate(treat = ifelse(treat==1, "treat", "not-treat"))
data_eirt$treat <- as.factor(data_eirt$treat)
data_eirt$proflevel <- as.factor(data_eirt$proflevel)
data_eirt$abilcov <- as.factor(data_eirt$abilcov)

data_tina <- rio::import("../inst/extdata/data_tina.xlsx")

data_simon <- rio::import("../inst/extdata/daten_fdw_simon.xlsx")
```

## 1PL

Fitte 1pl-Modelle mit birtms.

```{r}
priors_1d_1pl <- prior("normal(0, 3)", class = "sd", group = "person") +
  prior("normal(0, 3)", class = "sd", group = "item")

fit_1d_1pl_spm_full1 <- birtms::birtm_aio(response_data = data_spm, response_columns = i1:i12,
                                          prior = priors_1d_1pl,
                                          file = "../inst/extdata/fit_1d_1pl_spm_full1b",
                                          refit = glob_refit)

priors_1d_1pl_token <- prior("normal(0, 3)", class = "sd", group = "token") +
  prior("normal(0, 3)", class = "sd", group = "item")

fit_1d_1pl_tina1 <- birtms::birtm_aio(response_data = data_tina, 
                                      response_columns = SuHT3.binary:KaKST1.binary,
                                      prior = priors_1d_1pl_token,
                                      file = "../inst/extdata/fit_1d_1pl_tina1",
                                      variable_specifications = list(person = 'token'),
                                      refit = glob_refit)

priors_1d_1pl_id <- prior("normal(0, 3)", class = "sd", group = "id") +
  prior("normal(0, 3)", class = "sd", group = "item")

# Ein Modell über alle Dimensionen hinweg konvergiert schlecht
# fit_1d_1pl_eirt1 <- birtms::birtm_aio(response_data = data_eirt, 
#                                       response_columns = Math.1:MathWordProb.1,
#                                       prior = priors_1d_1pl_id,
#                                       file = "../inst/extdata/fit_1d_1pl_eirt1",
#                                       variable_specifications = list(person = 'id'),
#                                       refit = glob_refit)
fit_1d_1pl_eirt_science1 <- birtms::birtm_aio(response_data = data_eirt, 
                                      response_columns = Science.1:Science.10,
                                      prior = priors_1d_1pl_id,
                                      file = "../inst/extdata/fit_1d_1pl_eirt_science1b",
                                      variable_specifications = list(person = 'id'),
                                      refit = glob_refit)

priors_1d_1pl_Usercode <- prior("normal(0, 3)", class = "sd", group = "Usercode") +
  prior("normal(0, 3)", class = "sd", group = "item")

fit_1d_1pl_simon1 <- birtms::birtm_aio(response_data = data_simon,
                                       response_columns = p001MC_02:p076MC_07,
                                       prior = priors_1d_1pl_Usercode,
                                       file = "../inst/extdata/fit_1d_1pl_simon1",
                                       variable_specifications = list(person = 'Usercode'),
                                       refit = glob_refit)
```

Berechne marginale Loglikelihood und marginal-loo-cv:

```{r}
# mll_spm <- marginal_loglik(fit_1d_1pl_spm_full1, n_nodes = 3) # check_n_nodes ist hier nicht nötig (bereits mit 5 nodes konvergiert)
# mll_simon <- marginal_loglik(fit_1d_1pl_simon1) # braucht 17 - 33 nodes; schlechtere pareto k Werte als beim 1pl
# mll_tina <- marginal_loglik(fit_1d_1pl_tina1)
# mll_eirt <- marginal_loglik(fit_1d_1pl_eirt_science1)

loo_spm_1pl <- loo_marginal(fit_1d_1pl_spm_full1)
```

## 2PL

Fitte 2pl-Modelle

```{r}
# f <- birtms::build_formula(model_specifications = list(item_parameter_number = 2))
# d <- birtms::compose_dataset(response_data = data_spm,
#                                               response_columns = i1:i12)
# get_prior(f, d)

priors_1d_2pl <- prior("normal(0, 3)", nlpar = "skillintercept") +
  prior("normal(0, 1)", class = "b", nlpar = "logalpha") +
  prior("constant(1)", class = "sd", group = "person", nlpar = "theta") +
  prior("normal(0, 3)", class = "sd", group = "item", nlpar = "beta") +
  prior("normal(0, 1)", class = "sd", group = "item", nlpar = "logalpha")

fit_1d_2pl_spm_full1 <- birtms::birtm_aio(response_data = data_spm, response_columns = i1:i12,
                                          prior = priors_1d_2pl,
                                          model_specifications = list(item_parameter_number = 2),
                                          file = "../inst/extdata/fit_1d_2pl_spm_full1b",
                                          refit = glob_refit)

priors_1d_2pl_Usercode <- prior("normal(0, 3)", nlpar = "skillintercept") +
  prior("normal(0, 1)", class = "b", nlpar = "logalpha") +
  prior("constant(1)", class = "sd", group = "Usercode", nlpar = "theta") +
  prior("normal(0, 3)", class = "sd", group = "item", nlpar = "beta") +
  prior("normal(0, 1)", class = "sd", group = "item", nlpar = "logalpha")

fit_1d_2pl_simon1 <- birtms::birtm_aio(response_data = data_simon, response_columns = p001MC_02:p076MC_07,
                                          prior = priors_1d_2pl_Usercode,
                                          model_specifications = list(item_parameter_number = 2),
                                          file = "../inst/extdata/fit_1d_2pl_simon1",
                                          variable_specifications = list(person = 'Usercode'),
                                          refit = glob_refit)

priors_1d_2pl_token <- prior("normal(0, 3)", nlpar = "skillintercept") +
  prior("normal(0, 1)", class = "b", nlpar = "logalpha") +
  prior("constant(1)", class = "sd", group = "token", nlpar = "theta") +
  prior("normal(0, 3)", class = "sd", group = "item", nlpar = "beta") +
  prior("normal(0, 1)", class = "sd", group = "item", nlpar = "logalpha")

fit_1d_2pl_tina1 <- birtms::birtm_aio(response_data = data_tina, 
                                      response_columns = SuHT3.binary:KaKST1.binary,
                                      prior = priors_1d_2pl_token,
                                      model_specifications = list(item_parameter_number = 2),
                                      file = "../inst/extdata/fit_1d_2pl_tina1",
                                      variable_specifications = list(person = 'token'),
                                      refit = glob_refit)

priors_1d_2pl_id <- prior("normal(0, 3)", nlpar = "skillintercept") +
  prior("normal(0, 1)", class = "b", nlpar = "logalpha") +
  prior("constant(1)", class = "sd", group = "id", nlpar = "theta") +
  prior("normal(0, 3)", class = "sd", group = "item", nlpar = "beta") +
  prior("normal(0, 1)", class = "sd", group = "item", nlpar = "logalpha")

fit_1d_2pl_eirt1 <- birtms::birtm_aio(response_data = data_eirt, 
                                      Science.1:Science.10,
                                      prior = priors_1d_2pl_id,
                                      file = "../inst/extdata/fit_1d_2pl_eirt_science1b",
                                      variable_specifications = list(person = 'id'),
                                      model_specifications = list(item_parameter_number = 2),
                                      refit = glob_refit)

```

Berechne marginale Loglikelihood und marginal-loo-cv:

```{r}
# mll_spm_2pl <- marginal_loglik(fit_1d_2pl_spm_full1) # bessere pareto k Werte als das 1pl Modell
# mll_simon_2pl <- marginal_loglik(fit_1d_2pl_simon1)
# mll_tina_2pl <- marginal_loglik(fit_1d_2pl_tina1)
# mll_eirt_2pl <- marginal_loglik(fit_1d_2pl_eirt1) # <- 1pl model generalises better!

loo_spm_2pl <- loo_marginal(fit_1d_2pl_spm_full1)
```

## ICC plots    

```{r}
posterior_responses_eirt_1pl <- get_postdata(fit_1d_1pl_eirt_science1)
(g_eirt_1pl <- ICC_check(fit_1d_1pl_eirt_science1, post_responses = posterior_responses_eirt_1pl, num_groups = 6,
                         #ellipse_type = "norm"
                         ))

posterior_responses_eirt_2pl <- get_postdata(fit_1d_2pl_eirt1)
(g_eirt_2pl <- ICC_check(fit_1d_2pl_eirt1, post_responses = posterior_responses_eirt_2pl, num_groups = 6,
                         ellipse_type = "norm"))

posterior_responses_spm_1pl <- get_postdata(fit_1d_1pl_spm_full1)
(g_spm_1pl <- ICC_check(fit_1d_1pl_spm_full1, post_responses = posterior_responses_spm_1pl, num_groups = 6,
                         #ellipse_type = "norm"
                         ))

posterior_responses_spm_2pl <- get_postdata(fit_1d_2pl_spm_full1)
(g_spm_2pl <- ICC_check(fit_1d_2pl_spm_full1, post_responses = posterior_responses_spm_2pl, num_groups = 6,
                         #ellipse_type = "norm"
                         ))

posterior_responses_simon_1pl <- get_postdata(fit_1d_1pl_simon1)
(g_simon_1pl <- ICC_check(fit_1d_1pl_simon1, post_responses = posterior_responses_simon_1pl, item_id = 2,
                          ellipse_type = "axisparallel"))

posterior_responses_simon_2pl <- get_postdata(fit_1d_2pl_simon1)
(g_simon_2pl <- ICC_check(fit_1d_2pl_simon1, post_responses = posterior_responses_simon_2pl, item_id = 2,
                          ellipse_type = "norm"))

posterior_responses_tina_1pl <- get_postdata(fit_1d_1pl_tina1)
(g_tina_1pl <- ICC_check(fit_1d_1pl_tina1, post_responses = posterior_responses_tina_1pl, item_id = 1, num_groups = 6))

posterior_responses_tina_2pl <- get_postdata(fit_1d_2pl_tina1)
(g_tina_2pl <- ICC_check(fit_1d_2pl_tina1, post_responses = posterior_responses_tina_2pl, item_id = 7, num_groups = 6))
```

```{r}
or_data <- birtms::get_or(fit_1d_1pl_spm_full1, zero_correction = 'Haldane')#, n_samples = 100) # 2 s for 100 samples
or_data %>% birtms::plot_ppmc_or_heatmap(itemrange = c(1,20))

or_data2 <- birtms::get_or(fit_1d_1pl_tina1, zero_correction = 'Haldane', n_samples = 1000) # 24.4 s for 50 samples, 33.3 s for 100
or_data2 %>% birtms::plot_ppmc_or_heatmap(itemrange = c(1,20))

or_data3 <- birtms::get_or(fit_1d_2pl_tina1, zero_correction = 'Haldane', n_samples = 50)
or_data3 %>% birtms::plot_ppmc_or_heatmap(itemrange = c(1,20))

or_data4 <- birtms::get_or(fit_1d_1pl_simon1, zero_correction = 'Haldane', n_samples = 100)
# 596.5 s für 50, 867.3 s für 100, 691.6 s für 200, 738 s für 400 samples
or_data4 %>% birtms::plot_ppmc_or_heatmap(itemrange = c(1,20))

or_data %>% birtms::plot_or_heatmap()
```
